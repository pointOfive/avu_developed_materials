---
title: "ggplot2_3"
author: "Schwartz"
date: "11/2/2020"
output:
     html_document:
          toc: TRUE
          toc_depth: 4
          toc_float: true
          toc_collapsed: true
          theme: journal
          code_folding: show
---

<!--- Change font size for headers --->
<style>
h1.title {
  font-size: 34px;
}
h1 {
  font-size: 30px;
}
h2 {
  font-size: 26px;
}
h3 { 
  font-size: 22px;
}

div.tocify {
  width: 15%;
  max-width: 150px;
  }

.toc-content {
  padding-left: 20%;
  padding-right: 0px;
  width: 95%;
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE, 
                      fig.align = "center",
                      out.width = "80%")
```


# Resources

## Code 

### Manual Pages

- [geom_smooth](https://ggplot2.tidyverse.org/reference/geom_smooth.html)
- [geom_histogram](https://ggplot2.tidyverse.org/reference/geom_histogram.html)
- [adding text I](https://ggplot2.tidyverse.org/reference/annotate.html)
- [adding text II](https://ggplot2.tidyverse.org/reference/geom_text.html)
- [geom_density](https://ggplot2.tidyverse.org/reference/geom_density.html)
- [Multivariate Normal](https://stat.ethz.ch/R-manual/R-patched/library/MASS/html/mvrnorm.html)
- [geom_area](https://ggplot2.tidyverse.org/reference/geom_ribbon.html)
- [sample_n](https://dplyr.tidyverse.org/reference/sample.html)

### One-Off Answers

- [Displaying `.png` Images](https://stackoverflow.com/questions/9319298/preview-a-saved-png-in-an-r-device-window)
- [Control KDE bandwidth](https://stackoverflow.com/questions/12394321/r-what-algorithm-does-geom-density-use-and-how-to-extract-points-equation-of)
- [Legend Locations](https://stackoverflow.com/questions/10032513/ggplot2-legend-to-bottom-and-horizontal)
- [geom_smooth transparency](https://stackoverflow.com/questions/19474552/adjust-transparency-alpha-of-stat-smooth-lines-not-just-transparency-of-confi)
- [`ggally::ggpairs`](https://stackoverflow.com/questions/35085261/how-to-use-loess-method-in-ggallyggpairs-using-wrap-function) 
- [Sampling in `mutate`](https://stackoverflow.com/questions/29884432/dplyr-integer-sampling-within-mutate)

### General Resources

- [Mulitplot figures](http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/)
- [`ggforce`](https://www.data-imaginist.com/2019/a-flurry-of-facets/)

## Data

### Focus Article

- [Masking and Covid](https://www.ajtmh.org/content/journals/10.4269/ajtmh.20-1015)
- [Infection Models Predictions](https://ourworldindata.org/covid-models) 

### Generally

- [kaggle](https://www.kaggle.com/) 
- [seaborn](https://github.com/mwaskom/seaborn-data) 
- [CMU](http://lib.stat.cmu.edu/datasets/)  
- [Google Dataset Search](https://datasetsearch.research.google.com/)
- [data.world](https://data.world/search)
- [Data Portals](http://dataportals.org/)
- [UCIML Repo](http://archive.ics.uci.edu/ml/)
- [OpenDataMonitor](http://opendatamonitor.eu/)
- [Quandl](http://quandl.com/)
- [Wikipedia](https://en.wikipedia.org/wiki/List_of_datasets_for_machine-learning_research)
- [AWS data set](https://registry.opendata.aws/)
- [Quora.com](https://www.quora.com/Where-can-I-find-large-datasets-open-to-the-public)
- [The datasets subreddit](https://www.reddit.com/r/datasets)
- [Tycho](https://www.tycho.pitt.edu)
- [TFDS](https://www.tensorflow.org/datasets/catalog/overview)


# Masks

Here's some [data from a study on masking for covid](https://www.ajtmh.org/content/journals/10.4269/ajtmh.20-1015)

- Adding this to knitted markdown output is super easy, i.e., `![]()` 
- But I wanted to render this in RStudio (in R, not just knitted R), 
  which is a little bit more involved...


```{r inspiration, fig.height=2.5, fig.width=2.5}
library(tidyverse)

# https://stackoverflow.com/questions/9319298/preview-a-saved-png-in-an-r-device-window
#install.packages('png')
library('png')
path <- "/Users/gck8gd/Documents/courses/SDS_3003_Communication_w_Data/"
img <- readPNG(paste0(path,"ggplot2_2/paper_1.png",sep=""))
plot(0,0, ylab="", xlab="", bty="n", axes=FALSE)
grid::grid.raster(img)
```

- Does the association look strong to you?
    - What makes it look strong?
- Correlation is a value between $-1$ and $1$
- What does *correlation* ($r$) mean versus what the *slope* of the line means?
- Could there be confounders driving both masking adoption and mortality rate?
- Could the Y-axis (number of deaths) drive the X-axis time to adoption of masks?
- What does directional causality mean here?

```{r inspiration_question, fig.height=2.5, fig.width=2.5}
img <- readPNG(paste0(path,"ggplot2_2/paper_1copy2.png",sep=""))
plot(0,0, ylab="", xlab="", bty="n", axes=FALSE)
grid::grid.raster(img)
```


How do you feel about this now?
What does that mean?

## Null Hypothesis

Here we create data without any sort of association for 200 data points
(as above).

### Uncertainty

```{r uncorrelated, fig.height=1.75, fig.width=2}
n <- 200

tibble(weeks_std=rnorm(n), log_rate=rnorm(n)) %>%
  ggplot(aes(x=weeks_std, y=log_rate)) + geom_point() +
  # https://ggplot2.tidyverse.org/reference/geom_smooth.html
  geom_smooth(formula='y~x', method='lm', se=FALSE) -> fig
fig
```

- Watch out for figure scale!

```{r, fig.height=2, fig.width=.75}
fig
```

We can characterize how much variability there can be in these sorts of 
associations based on the evidence in front of us

```{r uncorrelated_v2, fig.height=1.75, fig.width=2}

fig + geom_smooth(formula='y~x', method='lm', se=TRUE)
```

- This plot has it all!
  - Association (the line)
  - Uncertainty of the estimated slope association (the gray band -- seems to be working)
  - Variability of data around the estimated slope of association

## Null Distribution 

### Histograms


```{r uncorrelated_correlations_when_n_is_200}
reps <- 100000
observed_correlations <- set_names(1:reps) %>% 
  purrr::map(~ cor(rnorm(n), rnorm(n)))
```

```{r uncorrelated_correlations_when_n_is_200_2, fig.height=1, fig.width=1.5}
tibble(correlations = unlist(observed_correlations)) %>%
  ggplot(aes(x=correlations)) + 
  # https://ggplot2.tidyverse.org/reference/geom_histogram.html
  geom_histogram(bins=20, color='black', fill='gray') +
  # https://ggplot2.tidyverse.org/reference/annotate.html
  annotate('text', x=sqrt(0.2811), y=0, label='*', color='red', size=10) 
  # https://ggplot2.tidyverse.org/reference/geom_text.html
```

- What can we change about histogram representation? 
- What is a `p-value`?

### KDEs

Kernel Density Estimates are "smoothed" versions of histograms


```{r uncorrelated_correlations_when_n_is_200_KDE_1}
reps <- 5000
set_names(1:reps) %>% map(~ cor(rnorm(n), rnorm(n))) -> observed_correlations
```

```{r uncorrelated_correlations_when_n_is_200_KDE_2, fig.height=1, fig.width=1.5}
tibble(correlations = unlist(observed_correlations)) %>%
  ggplot(aes(x=correlations)) +
  # https://ggplot2.tidyverse.org/reference/geom_density.html
  geom_density(fill='gray', adjust=1) + #bw=.01
  annotate('text', x=sqrt(0.2811) , y=0, label='*', color='red', size=10)
```

- What can we change about kernel density estimation representation? 
- What is a `p-value`?

# Synthetic Experiement

Let's explore how things work when the dependency between two variables 
is accurately characterized with the correlation from the above data


```{r correlated, fig.height=1.25, fig.width=1.5}
library(MASS)
# ?mvrnorm
# https://stat.ethz.ch/R-manual/R-patched/library/MASS/html/mvrnorm.html

n <- 200
mvrnorm(n, mu=c(0,0), 
        Sigma=matrix(c(1,sqrt(0.2811),sqrt(0.2811),1), nrow=2, byrow=TRUE)) %>%
  as_tibble() %>% rename(weeks_standarized=V1, log_rate_standarized=V2) -> 
  simulated_data
 
simulated_data %>%
  ggplot(aes(x=weeks_standarized, y=log_rate_standarized)) + geom_point() +
  geom_smooth(formula='y~x', method='lm', se=FALSE)

```


## Theoretical Uncertainty

```{r correlated_2, fig.height=1.25, fig.width=1.5}

simulated_data %>%
  ggplot(aes(x=weeks_standarized, y=log_rate_standarized)) + geom_point() +
  geom_smooth(formula='y~x', method='lm', se=TRUE)

```

- The size of n matters: try n=20!

```{r theoretial_confidence_intervals, fig.height=1.25, fig.width=1.5}

n <- 200
reps <- 10000
theoretial_correlations <- set_names(1:reps) %>% 
  map(~ mvrnorm(n, mu=c(0,0), 
                Sigma=matrix(c(1,sqrt(0.2811),sqrt(0.2811),1), nrow=2, byrow=TRUE))) %>%
  map(~ cor(.x[,1],.x[,2])) %>% unlist()
#  map(~ lm(.x[,1]~1+.x[,2])$coefficients[2]) %>% unlist()
# we could also pull out the slope instead of the correlation
# and assess the variation of the slope; but, 
# interesting fact: slope B=r*(sd_y/sd_x)
# and I set up this simulation so sd_y=sd_x so slope B=r
# so it's a very "unique" and "kinda weird" setup

my_kde_plot <- tibble(theoretial_correlations=theoretial_correlations) %>%
  # https://stackoverflow.com/questions/12394321/r-what-algorithm-does-geom-density-use-and-how-to-extract-points-equation-of
  ggplot(aes(x=theoretial_correlations)) + geom_density(fill='gray', adjust=1.5)

confidence_interval <- ggplot_build(my_kde_plot)$data[[1]] %>% 
  filter(x > quantile(theoretial_correlations, 0.025)) %>%
  filter(x < quantile(theoretial_correlations, 0.975)) %>%
  # https://ggplot2.tidyverse.org/reference/geom_ribbon.html
  geom_area(mapping=aes(x=x,y=y, color='95% Confidence Interval'), 
            fill='red', alpha=0.25) 
  
# https://stackoverflow.com/questions/10032513/ggplot2-legend-to-bottom-and-horizontal
my_kde_plot + confidence_interval + theme(legend.position="bottom") +
  ggtitle(paste0('If true correlation was\nsqrt(0.2811) and n=', n, sep=''))
```

- This is how confidence intervals are made!
  - we did this with a large simulation approximation; but,
  - you can also "work out the math"
- But... you wanna see something crazy?  Try n=20, and "fix it" with n=2000.

## Bootstrap Uncertainty


```{r correlated_3, fig.height=1.25, fig.width=1.5}
reps <- 100
bootstraps <- set_names(1:reps) %>% 
  # https://dplyr.tidyverse.org/reference/sample.html
  map(~ geom_line(data=sample_n(simulated_data, size=n, replace=TRUE),
                  mapping=aes(x=weeks_standarized, y=log_rate_standarized), 
                  stat="smooth", 
                  # https://stackoverflow.com/questions/19474552/adjust-transparency-alpha-of-stat-smooth-lines-not-just-transparency-of-confi
                  formula='y~x', method='lm', se=FALSE, alpha=0.5))

bootstraps[[1]] <- ggplot() + 
  geom_point(data=simulated_data, 
             mapping=aes(x=weeks_standarized, y=log_rate_standarized)) +
  bootstraps[[1]]

Reduce("+", bootstraps)
```

- We treat the "sample" as the "population" and "(re)-sample" from that 
  "population" over and over
- This is call "bootstrapping": i.e., "we use what we have"
  - e.g., you gotta pull yourself up?  Pull up from your bootstraps.

```{r bootstrap_confidence_intervals, fig.height=1.25, fig.width=1.5}

reps <- 10000
bootstrap_correlations <- set_names(1:reps) %>% 
  map(~ sample_n(simulated_data, size=n, replace=TRUE)) %>%
  map(~ cor(.x$weeks_standarized,.x$log_rate_standarized)) %>% unlist()
#  map(~ lm(.x$log_rate_standarized~1+.x$weeks_standarized)$coefficients[2]) %>% unlist()
# we could also pull out the slope instead of the correlation
# and assess the variation of the slope; but, 
# interesting fact: slope B=r*(sd_y/sd_x)
# and I set up this simulation so sd_y=sd_x so slope B=r
# so it's a very "unique" and "kinda weird" setup

my_histogram_plot <- tibble(bootstrap_correlations=bootstrap_correlations) %>% 
  ggplot(aes(x=bootstrap_correlations)) + geom_histogram(bins=20, fill='gray')

bootstrap_interval <- ggplot_build(my_histogram_plot)$data[[1]] %>%
  filter(xmin>quantile(bootstrap_correlations, 0.025)) %>%
  filter(xmax<quantile(bootstrap_correlations, 0.975)) %>%
  geom_col(mapping=aes(y=y,x=(xmin+xmax)/2, 
                       color='95% bootstrapped\nconfidence interval'), 
           fill='red', alpha=0.25)

my_histogram_plot + bootstrap_interval + theme(legend.position="bottom")

```
- We create bootstrap samples, and calculate our "statistic" for each bootstrap sample
- Then we take the "middle 95%" and that's a 95% bootstrap confidence interval

# HW [GROUP ASSIGNMENT]


*Each group member must contribute unique figures to the groups submission in order for all group members to get credit for this homework. If only some members of the group contribute figures in the submitted `.Rmd` file, those group members must additionally provide a supplemental explanation along with their submission as to why other students in their group have not contributed to this assignment.*

1. (Dis)Agreement between infection models
    - Previously we saw the infection predictions presented at [OWID](https://ourworldindata.org/covid-models) 
    - Leverage and make additions and changes to the code provided below to visualize the "degree of (dis)agreement" between THREE of the "prediction models" for a specific country (uniquely chosen by each group member)
        - E.g., each student will use a different `filter(Country='<pick1>')`
    - In your comparisons, use `geom_smooth(method='loess')` [as opposed to `geom_smooth(method='lm')`] to help highlight agreement and disagreement between the models
    - Collect all the "model prediction VS model prediction" plots into a single figure using something like, e.g., `gridExtra::grid.arrange(plotAvsB, plotAvsC, plotBvsC, nrow=2)`
    - Here [some helpul notes and explanations](http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/) about different ways different plots can be combined into a single figure
    

2. Each group member will then do the same again, but in an "all at once" manner:
    - Each student picks a new unique not yet used country 
    - and uses either [this `ggally::ggpairs` method](https://stackoverflow.com/questions/35085261/how-to-use-loess-method-in-ggallyggpairs-using-wrap-function) or [this `ggforce::facet_matrix` alternative](https://www.data-imaginist.com/2019/a-flurry-of-facets/) to create a "3-by-3" grid for the THREE [predictive models](https://ourworldindata.org/covid-models) you're considering (for their country of choice)
      - I.e., predictive models 1, 2, and 3 line up along the rows and columns
        of the figure
    

```{r hw_p1}
path_1 <- "/Users/gck8gd/Documents/courses/"
path_2 <- "SDS_3003_Communication_w_Data/ggplot2_2/"

file <- "daily-new-estimated-covid-19-infections-icl-model.csv"
icl_estimated_infections_totals <- read_csv(paste0(path_1,path_2,file,sep="")) %>%
  dplyr::select(-`Daily new confirmed cases due to COVID-19 (rolling 7-day average, right-aligned) Annotations`) %>%
  drop_na() %>%
  rename(Country=Entity) %>%
  rename(ICL_upper=`Daily new estimated infections of COVID-19 (ICL, upper)`) %>%
  rename(ICL_lower=`Daily new estimated infections of COVID-19 (ICL, lower)`) %>%
  rename(ICL_mean=`Daily new estimated infections of COVID-19 (ICL, mean)`)

file <- "daily-new-estimated-covid-19-infections-yyg-model.csv"
yyg_estimated_infections_totals <- read_csv(paste0(path_1,path_2,file,sep="")) %>%
  dplyr::select(-`Daily new confirmed cases due to COVID-19 (rolling 7-day average, right-aligned) Annotations`) %>%
  drop_na() %>%
  rename(Country=Entity) %>%
  rename(YYG_upper=`Daily new estimated infections of COVID-19 (YYG, upper)`) %>%
  rename(YYG_lower=`Daily new estimated infections of COVID-19 (YYG, lower)`) %>%
  rename(YYG_mean=`Daily new estimated infections of COVID-19 (YYG, mean)`)


# https://stackoverflow.com/questions/29884432/dplyr-integer-sampling-within-mutate
# a 95% confidence interval means 95% of the time the data will fall within
# this region; below, we draw a random sample from within this region
models_estimated_infections_totals <- icl_estimated_infections_totals %>% 
  inner_join(yyg_estimated_infections_totals) %>%
  filter(ICL_mean != 0 & YYG_mean != 0) %>%
  rowwise() %>% mutate(icl_possible = runif(1,ICL_lower,ICL_upper)) %>%
  rowwise() %>% mutate(yyg_possible = runif(1,YYG_lower,YYG_upper))

models_estimated_infections_totals
```


```{r hw_p2}
focus <- c('Sweden', 'United States', 'Denmark', 'Finland', 'Norway', 
           'South Korea', 'Japan', 'China', 'Vietnam', 'New Zealand')

models_estimated_infections_totals %>%
  filter(Country %in% focus) %>%
  mutate(log_icl_possible=log(icl_possible),
         log_yyg_possible=log(yyg_possible))  %>%
  ggplot(mapping=aes(x=log_icl_possible,y=log_yyg_possible)) + geom_point() +
  geom_abline(intercept=0, slope=1, color='red') +# geom_smooth(method='loess') +
  facet_wrap(~ Country, nrow=4, scales='free')


```


